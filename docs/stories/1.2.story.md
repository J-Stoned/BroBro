# Story 1.2: Chroma Vector Database Setup

## Status
Complete

## Story
**As a** developer,
**I want** Chroma vector database running locally,
**so that** I can store and query embeddings for the knowledge base.

## Acceptance Criteria
1. Docker Desktop installed and running on Windows
2. Chroma container running on `localhost:8000` with persistent volume
3. Chroma collections created: `ghl-docs`, `ghl-tutorials`, `ghl-best-practices`, `ghl-snapshots`
4. Chroma MCP server configured in `.claude/settings.local.json`
5. Test connection to Chroma via MCP tool succeeds
6. Documentation includes instructions for starting/stopping Chroma

## Tasks / Subtasks
- [x] Install and configure Docker Desktop (AC: 1)
  - [x] Download Docker Desktop for Windows from official site
  - [x] Install Docker Desktop with WSL 2 backend
  - [x] Start Docker Desktop and verify it's running
  - [x] Test Docker installation with `docker --version`
  - [x] Configure Docker to auto-start with Windows (optional)
- [x] Create Chroma Docker configuration (AC: 2)
  - [x] Create docker-compose.yml for Chroma service
  - [x] Configure Chroma port mapping: 8000:8000
  - [x] Configure persistent volume mount: `./chroma_db:/chroma/chroma`
  - [x] Set Chroma environment variables if needed
  - [x] Test Chroma container startup: `docker-compose up -d`
  - [x] Verify Chroma is accessible at http://localhost:8000
- [x] Initialize Chroma collections (AC: 3)
  - [x] Create initialization script: `scripts/init-chroma-collections.js`
  - [x] Connect to Chroma using JavaScript client
  - [x] Create `ghl-docs` collection with 384-dimensional embeddings
  - [x] Create `ghl-tutorials` collection with metadata schema for videos
  - [x] Create `ghl-best-practices` collection for curated guides
  - [x] Create `ghl-snapshots` collection for marketplace snapshots
  - [x] Configure HNSW index parameters for optimal performance
  - [x] Verify collections exist with collection.list() query
- [x] Configure Chroma MCP server (AC: 4)
  - [x] Add Chroma server entry to `.mcp.json`
  - [x] Configure HTTP transport with URL: http://localhost:8000
  - [x] Set server ID as `chroma-db`
  - [x] Add environment variables if needed
  - [x] Restart Claude Code to load new MCP configuration
- [x] Test Chroma connection and functionality (AC: 5)
  - [x] Create test script: `tests/chroma-connection.test.js`
  - [x] Test basic query operation on empty collection
  - [x] Test adding a sample document with embedding
  - [x] Test semantic search query with cosine similarity
  - [x] Test metadata filtering capability
  - [x] Verify query response time is acceptable (<100ms for simple queries)
- [x] Document Chroma setup and usage (AC: 6)
  - [x] Add Chroma setup section to README.md
  - [x] Document how to start Chroma: `docker-compose up -d`
  - [x] Document how to stop Chroma: `docker-compose down`
  - [x] Document how to view Chroma logs: `docker logs chroma`
  - [x] Document how to reset database: remove chroma_db/ directory
  - [x] Add troubleshooting section for common Docker/Chroma issues

## Dev Notes

### Chroma Vector Database Overview
[Source: architecture/4-system-architecture.md, architecture/5-knowledge-base-architecture.md]

Chroma is a lightweight, local-first vector database that will store embeddings for semantic search across the GHL knowledge base. It uses HNSW (Hierarchical Navigable Small World) indexing for fast approximate nearest neighbor search.

**Server Configuration:**
- **Transport:** HTTP (localhost:8000)
- **Framework:** Official Chroma Python server
- **Deployment:** Docker container
- **Persistent Storage:** Local volume mount at `./chroma_db`

### Collection Schema
[Source: architecture/4-system-architecture.md]

**Four collections required:**

1. **ghl-docs** (~5,000 vectors estimated)
   - embedding_dimension: 384
   - metadata_schema:
     - doc_title: string
     - doc_url: string
     - section: string
     - category: string (workflows|funnels|api|etc)
     - last_updated: date

2. **ghl-tutorials** (~2,000 vectors estimated)
   - embedding_dimension: 384
   - metadata_schema:
     - video_title: string
     - creator: string
     - video_url: string
     - timestamp: string
     - duration: integer
     - publish_date: date
     - topics: array<string>

3. **ghl-best-practices** (~500 vectors estimated)
   - embedding_dimension: 384
   - metadata_schema:
     - practice_title: string
     - category: string
     - source: string
     - effectiveness: string (proven|experimental)

4. **ghl-snapshots** (~200 vectors estimated)
   - embedding_dimension: 384
   - metadata_schema:
     - snapshot_name: string
     - marketplace: string (extendly|ghl-central|etc)
     - features: array<string>
     - pricing: string
     - use_cases: array<string>

**Total Estimated Storage:** ~11 MB (7,700 vectors * 384 dims * 4 bytes)

### HNSW Index Configuration
[Source: architecture/5-knowledge-base-architecture.md]

```python
collection.modify(
    metadata={
        "hnsw:space": "cosine",        # cosine similarity for semantic search
        "hnsw:construction_ef": 200,   # higher = better recall, slower indexing
        "hnsw:search_ef": 100,         # higher = better recall, slower queries
        "hnsw:M": 16                   # connections per layer
    }
)
```

### Docker Compose Configuration

**Create docker-compose.yml:**
```yaml
version: '3.8'
services:
  chroma:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_db:/chroma/chroma
    environment:
      - ALLOW_RESET=true
      - IS_PERSISTENT=true
```

### MCP Server Configuration
[Source: architecture/source-tree.md]

**Add to `.claude/settings.local.json`:**
```json
{
  "mcp": {
    "servers": {
      "chroma-db": {
        "transport": "http",
        "url": "http://localhost:8000"
      }
    }
  }
}
```

### Chroma Client Usage Pattern

```javascript
import { ChromaClient } from 'chromadb';

const client = new ChromaClient({ path: 'http://localhost:8000' });

// Create collection
const collection = await client.createCollection({
  name: 'ghl-docs',
  metadata: {
    'hnsw:space': 'cosine'
  }
});

// Add documents with embeddings
await collection.add({
  ids: ['doc1', 'doc2'],
  embeddings: [[0.1, 0.2, ...], [0.3, 0.4, ...]],
  documents: ['text1', 'text2'],
  metadatas: [{title: 'Doc 1'}, {title: 'Doc 2'}]
});

// Query
const results = await collection.query({
  queryEmbeddings: [[0.1, 0.2, ...]],
  nResults: 5
});
```

### Performance Expectations
[Source: architecture/11-testing-strategy.md]

- Simple queries (5 results): <100ms
- Complex queries with metadata filters: <500ms
- Bulk insert (100 documents): <2 seconds
- Collection initialization: <1 second

### Testing

**Test Standards:**
[Source: architecture/11-testing-strategy.md]

- Create `tests/chroma-connection.test.js` for connection and basic operations
- Test collection creation and listing
- Test document insertion with embeddings
- Test semantic search queries
- Test metadata filtering
- Verify query performance benchmarks
- Use Jest as testing framework

**Test Coverage:**
- Connection establishment
- Collection CRUD operations
- Document operations (add, query, delete)
- Error handling for connection failures
- Performance benchmarks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-25 | 1.1 | Story implementation completed - all ACs met | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries required for this story.

### Completion Notes List
- Created docker-compose.yml with comprehensive Windows/WSL2 configuration notes (addressing QA feedback ARCH-001)
- Added ALLOW_RESET as environment variable with security note (addressing QA feedback SEC-001)
- Added chromadb dependency (v1.8.0) to package.json
- Created 6 npm scripts for Chroma management: start-chroma, stop-chroma, restart-chroma, chroma-logs, init-chroma, test:chroma (addressing QA feedback DOC-002)
- Created scripts/init-chroma-collections.js with all 4 collections (ghl-docs, ghl-tutorials, ghl-best-practices, ghl-snapshots)
- Configured HNSW parameters for optimal semantic search: cosine similarity, construction_ef=200, search_ef=100, M=16
- Implemented comprehensive error handling with connection diagnostics and troubleshooting guidance
- Created tests/chroma-connection.test.js with 8 tests covering connection, CRUD operations, semantic search, metadata filtering, and performance benchmarks
- Created .mcp.json for Chroma MCP server configuration (HTTP transport to localhost:8000)
- Updated README.md with dedicated Chroma section including setup, management, collection configuration, persistent storage notes, and Windows-specific troubleshooting
- All 6 acceptance criteria met

### File List
- Created: `docker-compose.yml` (Chroma service configuration with Windows/WSL2 notes)
- Created: `.mcp.json` (Chroma MCP server configuration)
- Created: `scripts/init-chroma-collections.js` (Collection initialization with HNSW config)
- Created: `tests/chroma-connection.test.js` (8 comprehensive tests)
- Modified: `package.json` (added chromadb dependency and 6 npm scripts)
- Modified: `README.md` (added Chroma section with setup, management, and troubleshooting)

## QA Results

### Review Date: 2025-10-25

### Reviewed By: Quinn (Test Architect)

### Summary
Story 1.2 provides excellent technical detail for Chroma setup with comprehensive collection schemas and performance expectations. However, two medium-severity issues need attention: unclear story dependencies and missing Windows/WSL2-specific configuration guidance.

### Strengths
- ✅ Excellent technical detail with collection schemas and metadata structures
- ✅ Comprehensive HNSW index configuration with performance tuning
- ✅ Clear docker-compose.yml example with proper volume mounting
- ✅ Well-defined performance expectations (<100ms queries, <2s bulk insert)
- ✅ Detailed Chroma client usage patterns with code examples
- ✅ Good test coverage plan for connection, CRUD, and performance

### Findings
**Medium Severity Issues (2):**

1. **REQ-001:** Story assumes Docker Desktop is available but AC1 requires installation - missing dependency on story 1.1
   - **Suggested Action:** Add explicit dependency on story 1.1 completion. Clarify if Docker installation is a prerequisite or part of this story.

2. **ARCH-001:** Missing Windows-specific Docker/WSL2 configuration details and troubleshooting
   - **Suggested Action:** Add Windows-specific notes: WSL2 backend requirements, memory allocation, drive mounting permissions

**Low Severity Issues (3):**

3. **TEST-002:** Test script location already correct but worth noting naming convention
   - **Suggested Action:** Ensure consistent .test.js naming across all test files

4. **DOC-002:** Missing npm script for Chroma initialization and testing
   - **Suggested Action:** Add npm scripts: 'init-chroma', 'test:chroma' to package.json

5. **SEC-001:** ALLOW_RESET=true in docker-compose poses security risk for production
   - **Suggested Action:** Add note that ALLOW_RESET should be false in production environments

### Testability Score: 8/10
All ACs testable, but Docker/WSL2 setup needs Windows-specific verification:
- Docker Desktop health check
- Chroma container startup/connectivity test
- Collection creation and schema validation
- MCP HTTP transport connection test
- Performance benchmarks for query operations
- Windows volume mount permission test

### NFR Validation
- **Performance:** PASS - Clear expectations, HNSW properly configured
- **Reliability:** CONCERNS - Windows volume mounting can be problematic
- **Security:** CONCERNS - ALLOW_RESET=true is dev-only setting
- **Maintainability:** PASS - Good docs, clear schemas
- **Scalability:** PASS - HNSW params appropriate for 7.7K vectors, can grow to 50K+

### Platform-Specific Risks (Windows)
- WSL2 backend required - not all Windows installs have WSL2
- Volume mounting can fail due to permissions
- Docker Desktop memory defaults may be too low (recommend 4GB+)

### Recommendations
**Must Address:**
- Clarify Docker installation scope and story dependencies
- Add Windows/WSL2 configuration section to Dev Notes

**Future Enhancements:**
- Add docker health check script (scripts/check-chroma-health.js)
- Add npm script for one-command setup: npm run setup:chroma
- Consider Chroma backup/restore documentation

### Gate Status
Gate: **CONCERNS** → [docs/qa/gates/1.2-chroma-vector-database-setup.yml](../qa/gates/1.2-chroma-vector-database-setup.yml)

**Decision:** Story can proceed with awareness of dependency and Windows-specific issues. Recommend addressing REQ-001 and ARCH-001 before development starts.
