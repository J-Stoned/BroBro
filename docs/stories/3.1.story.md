# Story 3.1: GHL API MCP Server Foundation

## Status
Ready for Development

## Story
**As a** developer,
**I want** a TypeScript MCP server with proper project structure and FastMCP integration,
**so that** I can build GHL API tools on a solid foundation.

## Acceptance Criteria
1. `mcp-servers/ghl-api-server/` directory created with TypeScript project structure
2. `package.json` includes FastMCP, @gohighlevel/api-client v2.2.1, Zod for validation
3. `tsconfig.json` configured for ES2022, strict type checking, NodeNext module resolution
4. `src/index.ts` created with FastMCP server initialization and proper error handling
5. Server supports stdio transport (dev) with HTTP transport scaffolded for future use
6. Build script compiles TypeScript to `dist/` without errors
7. Server starts successfully and responds to MCP handshake
8. `test_connection` tool implemented to verify server functionality
9. Logging utility created with timestamp and severity levels
10. All dependencies installed and version locked in package-lock.json

## Tasks / Subtasks
- [ ] Create MCP server project structure (AC: 1)
  - [ ] Verify `mcp-servers/` directory exists (create if needed)
  - [ ] Create `mcp-servers/ghl-api-server/` directory
  - [ ] Create `src/`, `dist/`, `tests/` subdirectories
  - [ ] Create directory structure for tools: `src/tools/`, `src/auth/`, `src/utils/`
  - [ ] Create `.gitignore` with node_modules, dist, .env, .tokens.enc
  - [ ] Document directory structure in README.md
- [ ] Initialize TypeScript project (AC: 2, 3)
  - [ ] Run `npm init -y` in `mcp-servers/ghl-api-server/`
  - [ ] Update `package.json` with project metadata and ES modules ("type": "module")
  - [ ] Install FastMCP: `npm install fastmcp`
  - [ ] Install GHL client: `npm install @gohighlevel/api-client@2.2.1`
  - [ ] Install Zod: `npm install zod`
  - [ ] Install dev dependencies: `npm install -D typescript @types/node ts-node`
  - [ ] Create `tsconfig.json` with ES2022 target, NodeNext modules, strict mode
  - [ ] Configure module resolution, output directory (dist), and source maps
  - [ ] Add build, dev, and start scripts to package.json
  - [ ] Verify TypeScript compiler is working: `npx tsc --version`
- [ ] Create logging utility (AC: 9)
  - [ ] Create `src/utils/logger.ts` module
  - [ ] Implement log levels: DEBUG, INFO, WARN, ERROR
  - [ ] Add timestamp formatting (ISO 8601)
  - [ ] Add color coding for terminal output (optional, non-blocking)
  - [ ] Test logger with sample messages at different levels
- [ ] Create FastMCP server entry point (AC: 4, 5, 7)
  - [ ] Create `src/index.ts` with FastMCP initialization
  - [ ] Configure server metadata: name='ghl-api', version='1.0.0'
  - [ ] Configure stdio transport for local development
  - [ ] Add HTTP transport configuration (commented out with TODO for Story 3.6)
  - [ ] Implement server lifecycle methods: start, error handling, graceful shutdown
  - [ ] Add environment variable loading (dotenv) for configuration
  - [ ] Import and initialize logger
  - [ ] Add startup logging with server info and transport mode
- [ ] Implement test_connection tool (AC: 8)
  - [ ] Create `src/tools/test.ts` module
  - [ ] Define Zod schema for test_connection (empty object)
  - [ ] Implement handler returning: status, server name, version, timestamp
  - [ ] Register tool in `src/index.ts`
  - [ ] Test tool invocation manually
- [ ] Configure build and test server (AC: 6, 7, 10)
  - [ ] Add build script to package.json: `"build": "tsc"`
  - [ ] Add dev script: `"dev": "ts-node src/index.ts"`
  - [ ] Add start script: `"start": "node dist/index.js"`
  - [ ] Run `npm run build` and verify no compilation errors
  - [ ] Check `dist/` directory contains compiled JS files
  - [ ] Run `npm run start` and verify server starts
  - [ ] Test MCP handshake (use Claude Code or MCP inspector)
  - [ ] Test test_connection tool invocation
  - [ ] Run `npm install` to generate package-lock.json
  - [ ] Verify all dependencies are locked to specific versions
- [ ] Documentation (AC: 1)
  - [ ] Create `mcp-servers/ghl-api-server/README.md`
  - [ ] Document project structure and purpose
  - [ ] Document build and run commands
  - [ ] Document environment variables needed (for future stories)
  - [ ] Add link to main project documentation

## Dev Notes

### Project Structure
[Source: architecture/source-tree.md]

```
mcp-servers/ghl-api-server/
├── src/
│   ├── index.ts              # FastMCP server setup
│   ├── auth/
│   │   ├── oauth.ts          # OAuth 2.0 manager (Story 3.2)
│   │   └── token-store.ts    # Encrypted token storage (Story 3.2)
│   ├── tools/
│   │   ├── test.ts           # Test connection tool
│   │   ├── workflows.ts      # Workflow operations (Story 3.4)
│   │   ├── contacts.ts       # Contact management (Story 3.5)
│   │   ├── funnels.ts        # Funnel tools (Story 3.5)
│   │   └── calendars.ts      # Calendar operations (Story 3.5)
│   └── utils/
│       ├── rate-limiter.ts   # API rate limiting (Story 3.3)
│       ├── validators.ts     # Zod schemas
│       └── logger.ts         # Logging utility
├── dist/                     # Compiled JS (git ignored)
├── tests/                    # Unit tests (future)
├── package.json
├── package-lock.json
├── tsconfig.json
├── .gitignore
└── README.md
```

### Technology Stack
[Source: architecture/3-tech-stack.md, architecture/4-system-architecture.md]

**MCP Framework:** FastMCP (TypeScript)
- Zero boilerplate MCP server creation
- Zod validation built-in
- Built on official @modelcontextprotocol/sdk
- Production-ready with full TypeScript support

**GHL API Client:** @gohighlevel/api-client v2.2.1
- Official GoHighLevel SDK
- OAuth 2.0 support with auto token refresh
- Comprehensive endpoint coverage
- TypeScript definitions included

**Validation:** Zod
- Schema validation for MCP tool inputs
- Runtime type checking
- Excellent TypeScript integration

### FastMCP Server Pattern

**Minimal Server Implementation:**
```typescript
// src/index.ts
import { FastMCP } from 'fastmcp';
import { z } from 'zod';
import { logger } from './utils/logger.js';

const server = new FastMCP({
  name: 'ghl-api',
  version: '1.0.0',
  transport: 'stdio'
});

// Test connection tool
server.addTool({
  name: 'test_connection',
  description: 'Test MCP server connection and verify server is running',
  schema: z.object({}),
  handler: async () => {
    return {
      status: 'connected',
      server: 'ghl-api',
      version: '1.0.0',
      timestamp: new Date().toISOString()
    };
  }
});

// Start server
logger.info('Starting GHL API MCP Server...');
server.start();
logger.info('Server started successfully on stdio transport');
```

### TypeScript Configuration

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**Key Configuration Notes:**
- `NodeNext` module resolution is required for ES modules in TypeScript
- `strict: true` enables all strict type checking options
- Source maps enable debugging compiled code
- Declaration files support IDE autocomplete

### Package.json Scripts

**Essential Scripts:**
```json
{
  "name": "ghl-api-server",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "build": "tsc",
    "dev": "ts-node src/index.ts",
    "start": "node dist/index.js",
    "clean": "rm -rf dist"
  },
  "dependencies": {
    "fastmcp": "^latest",
    "@gohighlevel/api-client": "2.2.1",
    "zod": "^latest"
  },
  "devDependencies": {
    "typescript": "^5.x",
    "@types/node": "^20.x",
    "ts-node": "^latest"
  }
}
```

### Logger Utility Pattern

**src/utils/logger.ts:**
```typescript
export enum LogLevel {
  DEBUG = 'DEBUG',
  INFO = 'INFO',
  WARN = 'WARN',
  ERROR = 'ERROR'
}

class Logger {
  log(level: LogLevel, message: string, ...args: any[]): void {
    const timestamp = new Date().toISOString();
    const formattedMessage = `[${timestamp}] [${level}] ${message}`;

    if (level === LogLevel.ERROR) {
      console.error(formattedMessage, ...args);
    } else if (level === LogLevel.WARN) {
      console.warn(formattedMessage, ...args);
    } else {
      console.log(formattedMessage, ...args);
    }
  }

  debug(message: string, ...args: any[]): void {
    this.log(LogLevel.DEBUG, message, ...args);
  }

  info(message: string, ...args: any[]): void {
    this.log(LogLevel.INFO, message, ...args);
  }

  warn(message: string, ...args: any[]): void {
    this.log(LogLevel.WARN, message, ...args);
  }

  error(message: string, ...args: any[]): void {
    this.log(LogLevel.ERROR, message, ...args);
  }
}

export const logger = new Logger();
```

### .gitignore Configuration

**Critical Files to Ignore:**
```
# Dependencies
node_modules/

# Build outputs
dist/
*.js
*.js.map
*.d.ts
*.d.ts.map

# Environment and secrets
.env
.env.local
.tokens.enc
*.pem
*.key

# Logs
*.log
logs/

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db
```

### Testing Strategy
[Source: architecture/11-testing-strategy.md]

**Manual Testing for This Story:**
1. Verify TypeScript compiles without errors
2. Verify server starts and logs startup message
3. Test MCP handshake (use Claude Code MCP panel or MCP inspector)
4. Test test_connection tool invocation
5. Verify tool returns correct schema
6. Test server graceful shutdown (Ctrl+C)

**Success Criteria:**
- Zero TypeScript compilation errors
- Server starts in <2 seconds
- MCP handshake succeeds
- test_connection tool returns status='connected'
- Logs show INFO level messages for startup

### Dependencies on Other Stories

**Blocks:**
- Story 3.2 (OAuth) - Requires this foundation
- Story 3.3 (Rate Limiting) - Requires this foundation
- Story 3.4 (Workflow Tools) - Requires this foundation
- Story 3.5 (Other Tools) - Requires this foundation

**Blocked By:**
- None (first story in Epic 3)

### Common Issues and Troubleshooting

**Issue: TypeScript module resolution errors**
- Solution: Ensure `"type": "module"` in package.json and `"module": "NodeNext"` in tsconfig.json

**Issue: FastMCP not found**
- Solution: Run `npm install` and verify package-lock.json is generated

**Issue: Server doesn't start**
- Solution: Check logs for errors, verify all dependencies installed, ensure no port conflicts

**Issue: MCP handshake fails**
- Solution: Verify stdio transport is configured, check Claude Code MCP settings

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-10-26 | 2.0 | Enhanced to production-ready status with detailed tasks, enhanced AC (10 items), comprehensive dev notes, logger utility, troubleshooting guide. Status changed to Ready for Development. | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_(To be filled by Dev Agent)_

### Debug Log References
_(To be filled by Dev Agent)_

### Completion Notes List
_(To be filled by Dev Agent)_

### File List
_(To be filled by Dev Agent)_

## QA Results

**Review Date:** 2025-10-26 (v2.0)
**Reviewer:** Bob (Scrum Master)
**Gate Status:** READY FOR DEVELOPMENT

### Summary
Story 3.1 has been enhanced from draft to production-ready status with comprehensive acceptance criteria (10 items), detailed task breakdown with sub-tasks, enhanced dev notes with code examples, troubleshooting guide, and clear dependency mapping.

### Validation for Development
- ✅ All acceptance criteria are testable and measurable
- ✅ Tasks are specific and actionable with clear acceptance criteria mapping
- ✅ Technical approach is well-documented with FastMCP patterns
- ✅ Dependencies clearly identified (blocks Stories 3.2-3.5, no blockers)
- ✅ TypeScript configuration follows best practices
- ✅ Logger utility provides structured logging from day one
- ✅ .gitignore protects secrets and build artifacts
- ✅ Testing strategy defined for manual validation

**Testability Score:** 10/10

**Status Change:** Draft → Ready for Development
