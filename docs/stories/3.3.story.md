# Story 3.3: Rate Limiting & Error Handling

## Status
Complete

## Story
**As a** developer,
**I want** robust rate limiting and error handling,
**so that** the MCP server respects GHL API limits and gracefully handles failures.

## Acceptance Criteria
1. Rate limiter implemented: max 100 requests per 10 seconds
2. Daily limit tracker: max 200,000 requests per day
3. Requests queued when limits approached, with exponential backoff
4. Retry logic for transient errors (3 attempts with backoff)
5. Meaningful error messages for OAuth failures, rate limits, invalid requests
6. All errors logged with timestamp, endpoint, request details
7. MCP tool errors return structured error objects (not raw exceptions)

## Tasks / Subtasks
- [ ] Implement rate limiter (AC: 1, 2)
  - [ ] Create `src/utils/rate-limiter.ts` module
  - [ ] Track requests in 10-second sliding window
  - [ ] Enforce 100 requests per 10 seconds limit
  - [ ] Track daily request count
  - [ ] Enforce 200,000 requests per day limit
  - [ ] Queue requests when approaching limits
- [ ] Implement request queue with backoff (AC: 3)
  - [ ] Create request queue for rate-limited requests
  - [ ] Implement exponential backoff (1s, 2s, 4s, etc.)
  - [ ] Process queued requests when window clears
  - [ ] Log queue depth and wait times
- [ ] Implement retry logic (AC: 4)
  - [ ] Detect transient errors (network timeouts, 5xx errors)
  - [ ] Retry up to 3 times with exponential backoff
  - [ ] Log retry attempts
  - [ ] Return error after max retries exhausted
- [ ] Implement comprehensive error handling (AC: 5, 7)
  - [ ] Catch and categorize errors (OAuth, rate limit, validation, network)
  - [ ] Create structured error response format
  - [ ] Provide actionable error messages
  - [ ] Map HTTP status codes to user-friendly messages
- [ ] Implement error logging (AC: 6)
  - [ ] Log all errors with timestamp
  - [ ] Include endpoint, HTTP method, request ID
  - [ ] Include error type, message, stack trace
  - [ ] Rotate log files to prevent disk space issues
- [ ] Test error scenarios
  - [ ] Test rate limit enforcement
  - [ ] Test queue processing
  - [ ] Test retry logic
  - [ ] Test OAuth error handling
  - [ ] Test network error handling

## Dev Notes

### Rate Limiting Requirements
[Source: PRD Section 6-epic-details.md, architecture/4-system-architecture.md]

**GHL API Limits:**
- Burst limit: 100 requests per 10 seconds
- Daily limit: 200,000 requests per day

**Implementation:**
```typescript
class RateLimiter {
  private requestQueue: Array<{fn: Function, resolve: Function}> = [];
  private burstLimit = 100;    // 100 req / 10 seconds
  private dailyLimit = 200000; // 200k req / day
  private requestWindow: number[] = [];

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    await this.checkLimits();
    this.recordRequest();
    return await fn();
  }

  private async checkLimits(): Promise<void> {
    // Remove requests outside 10-second window
    // Check if under burst limit
    // Check daily limit
    // Queue and delay if limits exceeded
  }
}
```

### Error Categories

**OAuth Errors:**
- Invalid client credentials
- Expired access token
- Expired refresh token
- Missing authorization

**Rate Limit Errors:**
- Burst limit exceeded (100/10s)
- Daily limit exceeded (200k/day)
- 429 Too Many Requests from GHL

**Validation Errors:**
- Invalid input parameters
- Missing required fields
- Schema validation failures

**Network Errors:**
- Connection timeout
- DNS resolution failure
- SSL/TLS errors

**API Errors:**
- 400 Bad Request
- 404 Not Found
- 500 Internal Server Error

### Structured Error Response

```typescript
interface MCPError {
  code: string;           // ERROR_RATE_LIMIT, ERROR_OAUTH, etc.
  message: string;        // User-friendly message
  details?: any;          // Additional context
  timestamp: string;      // ISO 8601 timestamp
  endpoint?: string;      // API endpoint
  retryable: boolean;     // Can be retried
  retryAfter?: number;    // Seconds to wait before retry
}
```

### Retry Logic

**Retryable Errors:**
- Network timeouts
- 429 Rate Limit
- 500, 502, 503, 504 server errors

**Non-Retryable Errors:**
- 400 Bad Request (invalid input)
- 401 Unauthorized (OAuth failure)
- 403 Forbidden
- 404 Not Found

**Backoff Strategy:**
- Attempt 1: immediate
- Attempt 2: wait 1 second
- Attempt 3: wait 2 seconds
- Attempt 4: wait 4 seconds (if max retries = 4)

### Testing

Test scenarios:
- Burst limit enforcement (101st request in 10s queued)
- Daily limit enforcement (200,001st request rejected)
- Retry on transient errors
- No retry on validation errors
- Error logging completeness
- Structured error response format

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_(To be filled by Dev Agent)_

### Debug Log References
_(To be filled by Dev Agent)_

### Completion Notes List
_(To be filled by Dev Agent)_

### File List
_(To be filled by Dev Agent)_

## QA Results
_(To be filled by QA Agent)_
